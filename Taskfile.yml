version: '3'

vars:
  BINARY: dockge

tasks:
  default:
    desc: Show available tasks
    silent: true
    cmd: task --list

  setup:
    desc: Install all dependencies (first-time dev setup)
    cmds:
      - cd web && pnpm install
      - cd e2e && pnpm install
      - cd e2e && npx playwright install chromium

  build:
    desc: Build everything
    deps: [build-web, build-go]

  build-web:
    desc: Build frontend (Vite â†’ dist/)
    dir: web
    cmd: pnpm run build

  build-go:
    desc: Build Go backend
    cmd: go build -o {{.BINARY}} .
    sources:
      - '**/*.go'
      - go.mod
      - go.sum
    generates:
      - ./{{.BINARY}}

  build-mock-docker:
    desc: Build mock docker binary for dev/test
    cmd: go build -o test-data/bin/docker ./cmd/mock-docker
    sources:
      - cmd/mock-docker/**/*.go
      - go.mod
    generates:
      - test-data/bin/docker

  build-mock-daemon:
    desc: Build mock daemon binary for dev/test
    cmd: go build -o test-data/bin/mock-daemon ./cmd/mock-daemon
    sources:
      - cmd/mock-daemon/**/*.go
      - internal/docker/**/*.go
      - go.mod
    generates:
      - test-data/bin/mock-daemon

  dev:
    desc: Run mock daemon + Go backend + Vite HMR (ports 5001 + 5000)
    deps: [build-go, build-mock-daemon, build-mock-docker]
    cmds:
      - cmd: |
          trap 'kill 0' EXIT
          MOCK_SOCK="/tmp/dockge-mock-$$/docker.sock"
          mkdir -p "$(dirname "$MOCK_SOCK")"
          ./test-data/bin/mock-daemon \
            --socket "$MOCK_SOCK" \
            --stacks-source test-data/stacks \
            --stacks-dir test-data/stacks &
          for i in $(seq 1 50); do [ -S "$MOCK_SOCK" ] && break; sleep 0.1; done
          export DOCKER_HOST="unix://$MOCK_SOCK"
          export PATH="$(pwd)/test-data/bin:$PATH"
          (cd web && pnpm run dev) &
          ./{{.BINARY}} --dev --port 5001 --data-dir test-data --stacks-dir test-data/stacks &
          wait

  dev-web:
    desc: Run Vite dev server only (port 5000)
    dir: web
    cmd: pnpm run dev

  dev-go:
    desc: Run mock daemon + Go backend only (port 5001)
    deps: [build-go, build-mock-daemon, build-mock-docker]
    cmds:
      - cmd: |
          trap 'kill 0' EXIT
          MOCK_SOCK="/tmp/dockge-mock-$$/docker.sock"
          mkdir -p "$(dirname "$MOCK_SOCK")"
          ./test-data/bin/mock-daemon \
            --socket "$MOCK_SOCK" \
            --stacks-source test-data/stacks \
            --stacks-dir test-data/stacks &
          for i in $(seq 1 50); do [ -S "$MOCK_SOCK" ] && break; sleep 0.1; done
          export DOCKER_HOST="unix://$MOCK_SOCK"
          export PATH="$(pwd)/test-data/bin:$PATH"
          ./{{.BINARY}} --dev --port 5001 --data-dir test-data --stacks-dir test-data/stacks

  start-mock-env:
    desc: Start mock daemon + dockge for dev/test
    deps: [build-go, build-mock-daemon, build-mock-docker]
    vars:
      PORT: '{{.PORT | default "5001"}}'
      STACKS_DIR: '{{.STACKS_DIR | default "test-data/stacks"}}'
      DATA_DIR: '{{.DATA_DIR | default "test-data"}}'
    cmds:
      - cmd: |
          trap 'kill 0' EXIT
          MOCK_SOCK="/tmp/dockge-mock-$$/docker.sock"
          mkdir -p "$(dirname "$MOCK_SOCK")"
          ./test-data/bin/mock-daemon \
            --socket "$MOCK_SOCK" \
            --stacks-source test-data/stacks \
            --stacks-dir {{.STACKS_DIR}} &
          for i in $(seq 1 50); do [ -S "$MOCK_SOCK" ] && break; sleep 0.1; done
          DOCKER_HOST="unix://$MOCK_SOCK" PATH="$(pwd)/test-data/bin:$PATH" \
            exec ./{{.BINARY}} --dev --port {{.PORT}} --data-dir {{.DATA_DIR}} --stacks-dir {{.STACKS_DIR}}

  kill:
    desc: Kill any running dockge backend or Vite dev server
    ignore_error: true
    cmds:
      - cmd: pkill -f './{{.BINARY}}' 2>/dev/null
        ignore_error: true
      - cmd: pkill -f 'node.*vite' 2>/dev/null
        ignore_error: true
      - cmd: pkill -f 'mock-daemon' 2>/dev/null
        ignore_error: true

  clean:
    desc: Remove build artifacts
    cmd: rm -rf dist {{.BINARY}}

  check-ts:
    desc: TypeScript type check (tsc --noEmit)
    dir: web
    cmd: pnpm run check-ts

  lint:
    desc: Lint frontend and Go code
    cmds:
      - cmd: pnpm run lint
        dir: web
      - go vet ./...

  fmt:
    desc: Format frontend and Go code
    cmds:
      - cmd: pnpm run fmt
        dir: web
      - gofmt -w .

  test:
    desc: Run all tests
    deps: [test-go, test-e2e]

  test-go:
    desc: Run Go tests with race detector
    cmd: go test -race ./...

  test-e2e:
    desc: Run Playwright E2E tests
    deps: [build-web, build-go, build-mock-daemon, build-mock-docker]
    dir: e2e
    cmd: E2E_PORT=5052 pnpm test

  test-e2e-report:
    desc: Show Playwright HTML report with screenshot diffs
    dir: e2e
    cmd: pnpm run test:report

  update-screenshots:
    desc: Update E2E golden screenshots
    deps: [build-web, build-go, build-mock-daemon, build-mock-docker]
    dir: e2e
    cmd: E2E_PORT=5052 pnpm run test:update-screenshots

  test-e2e-trace:
    desc: Run E2E test with tracing (use -- <test-file>)
    deps: [build-web, build-go, build-mock-daemon, build-mock-docker]
    dir: e2e
    cmd: E2E_PORT=5052 npx playwright test {{.CLI_ARGS}} --trace on

  docker:
    desc: Build Docker image
    cmd: docker buildx build -f docker/Dockerfile -t cfilipov/dockge:latest --target release .
